# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

### Running the Application
```bash
# Quick start (recommended)
chmod +x run.sh
./run.sh

# Manual start
cd backend
uv run uvicorn app:app --reload --port 8000
```

### Development Commands
```bash
# Install dependencies
uv sync

# Run with different port
cd backend && uv run uvicorn app:app --reload --port 8001

# Check Python environment
uv python list
```

### Environment Setup
Create `.env` file in root directory:
```
ANTHROPIC_API_KEY=your_api_key_here
```

## Architecture Overview

This is a **RAG (Retrieval-Augmented Generation) chatbot** that answers questions about course materials using semantic search and Claude AI.

### Core Flow
1. **Documents** are pre-processed at startup from `/docs/*.txt` files
2. **Chunks** are created with overlap (800 chars, 100 overlap) and stored in ChromaDB
3. **Queries** trigger a tool-based search where Claude decides if semantic search is needed
4. **Responses** are generated by Claude using retrieved context from vector search

### Key Architectural Decisions

#### Tool-Based Search Pattern
The system uses Claude's native tool-calling capability rather than always performing retrieval:
- Claude receives `search_course_content` tool definition
- Claude decides whether to search based on query type
- General questions bypass search; specific course questions trigger retrieval
- Single search per query maximum (enforced in system prompt)

#### Dual Collection Strategy
ChromaDB maintains two collections:
- `course_catalog`: Course metadata for fuzzy name matching
- `course_content`: Actual content chunks with embeddings

This enables queries like "search in MCP course" to resolve "MCP" → full course title.

#### Session Management
- Sessions created on first query if not provided
- Maintains last 2 conversation exchanges (configurable in `config.py`)
- History passed as context to Claude for continuity

#### Document Processing Pipeline
1. **Parsing**: Extracts structured metadata (title, instructor, lessons) from convention-based format
2. **Chunking**: Sentence-aware splitting with configurable size/overlap
3. **Context Injection**: Prepends course/lesson info to chunks for better retrieval
4. **Deduplication**: Checks existing courses to avoid re-processing

### Important Files & Their Roles

- **backend/rag_system.py**: Main orchestrator - coordinates all components
- **backend/search_tools.py**: Implements tool interface for Claude's tool-calling
- **backend/vector_store.py**: ChromaDB wrapper with course resolution logic
- **backend/ai_generator.py**: Claude API integration with two-stage generation (tools → response)
- **backend/document_processor.py**: Text chunking and lesson extraction
- **backend/config.py**: All configurable parameters (chunk size, model, etc.)

### Configuration Points

Default settings in `backend/config.py`:
- `CHUNK_SIZE`: 800 (characters per chunk)
- `CHUNK_OVERLAP`: 100 (overlap between chunks)
- `MAX_RESULTS`: 5 (top-k search results)
- `MAX_HISTORY`: 2 (conversation turns to remember)
- `EMBEDDING_MODEL`: "all-MiniLM-L6-v2"
- `ANTHROPIC_MODEL`: "claude-sonnet-4-20250514"

### Document Format Expected

Course files in `/docs` should follow this format:
```
Course Title: [title]
Course Link: [url]
Course Instructor: [name]

Lesson 0: Introduction
[content...]

Lesson 1: [title]
Lesson Link: [url]
[content...]
```

### API Endpoints

- `POST /api/query`: Main query endpoint with session support
- `GET /api/courses`: Returns course statistics
- `GET /docs`: FastAPI automatic documentation

### Performance Considerations

- ChromaDB persists to `backend/chroma_db/` - delete this folder to rebuild index
- Initial document load happens on startup via `@app.on_event("startup")`
- Embeddings cached in ChromaDB, not regenerated per query
- Frontend shows loading state during 2-5 second typical response time

### Frontend Integration

- Static files served from `/frontend` directory
- Uses vanilla JavaScript with Marked.js for markdown rendering
- WebSocket not used - simple POST/response pattern
- Session ID stored client-side for conversation continuity
- always use uv to run the server. Do not use pip
- Always use uv to add dependencies
- Never start application